<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Property Map Watcher</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d8/QFX/jT6858e+MGEa2/s4X5/z1z/4s8c8M8M2Q2Q==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d8/QFX/jT6858e+MGEa2/s4X5/z1z/4s8c8M8M2Q2Q==" crossorigin=""></script>
    <style>
        /* Custom styles for map container */
        #map {
            height: 100vh;
            width: 100vw;
            z-index: 10; 
        }
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
        /* Custom card style */
        .card-shadow {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem; 
            padding: 0;
        }
        .leaflet-popup-content {
            margin: 0;
            padding: 1rem;
            max-width: 300px !important;
        }
        /* Ensure cursor remains drag-friendly on map (Critical fix) */
        .leaflet-grab { cursor: grab !important; }
        .leaflet-container { cursor: grab !important; }
        .leaflet-dragging .leaflet-grab { cursor: grabbing !important; }
        
        /* Custom map pin icon styles */
        .custom-temp-icon {
            animation: bounce 1s infinite alternate;
        }
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-10px); }
        }

        /* Manual Pin Drop Mode Styles */
        .manual-drop-mode .leaflet-container {
            cursor: crosshair !important;
        }
        .manual-drop-mode #map::after {
            content: "+";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: #DC2626; /* Red */
            pointer-events: none; /* Allows clicks to pass through */
            z-index: 999;
            text-shadow: 0 0 5px white;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased overflow-hidden">

    <!-- Loading Overlay (Z-Index 50) -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        <p id="loading-message" class="mt-4 text-lg font-semibold text-indigo-700">Initializing Map & Cloud Sync...</p>
    </div>

    <!-- Main Map Container -->
    <div id="map"></div>
    
    <!-- Floating Address Search Input (Z-INDEX 1000) -->
    <div class="fixed top-6 left-1/2 transform -translate-x-1/2 w-11/12 max-w-lg z-[1000]">
        <div class="relative shadow-xl rounded-full overflow-hidden bg-white">
            <input type="text" id="address-search-input" placeholder="Search address to place a pin..." class="w-full p-3 pl-12 border-none focus:ring-indigo-500 focus:border-indigo-500">
            <!-- Added ID to button and removed inline onclick -->
            <button id="search-btn" class="absolute inset-y-0 right-0 px-4 bg-indigo-500 text-white hover:bg-indigo-600 transition duration-150">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </button>
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.899A5.82 5.82 0 0110 18V8a2 2 0 014 0v10l3.657-3.657a1 1 0 011.414 1.414z" />
                </svg>
            </div>
        </div>
    </div>
    
    <!-- Manual Pin Drop Button (Top Right) -->
    <button id="manual-pin-btn" class="fixed top-6 right-6 p-3 bg-red-500 text-white rounded-lg shadow-xl hover:bg-red-600 transition duration-150 z-[1000] flex items-center space-x-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.899A5.82 5.82 0 0110 18V8a2 2 0 014 0v10l3.657-3.657a1 1 0 011.414 1.414z" />
        </svg>
        <span class="hidden sm:inline">Manual Pin</span>
    </button>

    
    <!-- Pin Detail Modal (Z-Index 50) -->
    <div id="pin-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl overflow-hidden card-shadow w-11/12 max-w-lg mx-auto transform transition-transform duration-300 scale-95 opacity-0">
            
            <header class="p-4 bg-indigo-600 text-white flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-bold">New Location Watch</h2>
                <!-- ADDED ID: close-modal-btn and removed inline onclick -->
                <button id="close-modal-btn" class="text-white hover:text-indigo-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </header>

            <div class="p-6 space-y-4">
                <input type="hidden" id="pin-id">
                
                <div>
                    <label for="property-name" class="block text-sm font-medium text-gray-700 mb-1">Property Name / Address (Lat: <span id="modal-lat"></span>, Lng: <span id="modal-lng"></span>)</label>
                    <input type="text" id="property-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="E.g., 123 Main St - Corner Lot">
                </div>

                <div>
                    <label for="property-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="property-status" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Watching">Watching (Initial Interest)</option>
                        <option value="Contacted">Contacted Owner/Agent</option>
                        <option value="Offer Made">Offer Made</option>
                        <option value="Rejected">Rejected/No longer viable</option>
                        <option value="Purchased" class="font-bold text-green-600">Purchased/Complete</option>
                    </select>
                </div>

                <div>
                    <label for="property-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes / Key Takeaways</label>
                    <textarea id="property-notes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Max bid, key features, zoning restrictions, etc."></textarea>
                </div>
            </div>

            <footer class="p-4 bg-gray-50 flex justify-between items-center border-t border-gray-200">
                <!-- REMOVED inline onclick="deletePin()" -->
                <button id="delete-pin-btn" class="text-red-600 hover:text-red-700 font-medium hidden">Delete</button>
                <!-- REMOVED inline onclick="savePin()" -->
                <button id="save-pin-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 font-semibold">
                    Save Location
                </button>
            </footer>
        </div>
    </div>
    
    <!-- User Info Footer / Status Bar (Z-Index 40) -->
    <div class="fixed bottom-0 left-0 right-0 p-1 text-xs flex justify-between items-center z-40 bg-white/90 backdrop-blur-sm border-t border-gray-200">
        <!-- Status Indicator -->
        <div id="status-indicator" class="px-2 py-1 rounded-full text-white font-medium ml-2">
            Loading...
        </div>
        
        <!-- User ID Info -->
        <div class="text-gray-500 flex items-center mr-2">
            User ID: <span id="user-id-display" class="font-mono ml-2">Loading...</span> | Cloud App: <span id="app-id-display" class="font-mono ml-2">Loading...</span>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // ====================================================================
        // --- CRITICAL FIX: FIREBASE CONFIGURATION FOR EXTERNAL DEPLOYMENT ---
        // Your provided credentials have been inserted here:
        // ====================================================================
        const realFirebaseConfig = {
            apiKey: "AIzaSyABT1nSD5liNMuVvAtmIw7sQAf_SJRuvCs", 
            authDomain: "commercial-property-map.firebaseapp.com",
            projectId: "commercial-property-map",
            storageBucket: "commercial-property-map.firebasestorage.app",
            messagingSenderId: "486434169699",
            appId: "1:486434169699:web:f0bb313ced152ca36b6956"
        };
        // ====================================================================

        // Logic to determine which config to use:
        // 1. If running in the Canvas environment, use the injected config.
        // 2. If running externally (i.e., on GitHub Pages), use 'realFirebaseConfig'.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config ? JSON.parse(__firebase_config) : realFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END: FIREBASE CONFIGURATION ---

        // Global State Variables
        let app;
        let db;
        let auth;
        let map;
        let currentUserId = null;
        let markers = {}; 
        let tempMarker = null; // New temporary marker for new/searched locations
        let isManualDropMode = false; // New state for manual pin mode

        const DEFAULT_LAT = 34.0522; // Los Angeles
        const DEFAULT_LNG = -118.2437; 
        const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=';

        let currentMarkerData = {
            id: null,
            lat: null,
            lng: null,
            marker: null,
        };
        
        let isAppInitialized = false;

        // --- UI STATUS UPDATER ---
        function updateStatus(message, colorClass) {
            const indicator = document.getElementById('status-indicator');
            indicator.textContent = message;
            indicator.className = `px-2 py-1 rounded-full text-white font-medium ml-2 ${colorClass}`;
        }


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initFirebase() {
            try {
                // 1. Initialize services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                updateStatus('Authenticating...', 'bg-indigo-500');
                
                // 2. Perform Sign In
                // The external version will use the 'else' block, signing in anonymously.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 3. Set up Auth State Listener and subsequent app flow
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('user-id-display').textContent = currentUserId;
                        document.getElementById('app-id-display').textContent = appId;
                        
                        if (!isAppInitialized) {
                            initMap();
                            startDataListener();
                            attachEventListeners();
                            isAppInitialized = true;
                        }
                    } else {
                        // This block should only hit if anonymous sign-in failed externally.
                        updateStatus('Sign In Failed', 'bg-red-500');
                    }
                });

            } catch (error) {
                console.error("CRITICAL ERROR: Firebase Initialization Failed.", error);
                document.getElementById('loading-message').textContent = 'Initialization Failed. Check console.';
                updateStatus('Initialization Error', 'bg-red-500');
            }
        }
        
        // --- MAP INITIALIZATION ---

        function initMap() {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setupLeafletMap(lat, lng);
                },
                (error) => {
                    console.warn(`Geolocation failed. Falling back to default. ${error.name}`);
                    setupLeafletMap(DEFAULT_LAT, DEFAULT_LNG);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
        }
        
        function setupLeafletMap(lat, lng) {
            map = L.map('map', { 
                zoomControl: false, 
            }).setView([lat, lng], 13);
            
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Initial map click listener (always active)
            map.on('click', onMapClick);

            // Remove loading overlay and update status
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.add('hidden'); }, 500);
            updateStatus('Map & Database Ready', 'bg-green-600');
        }
        
        // --- ADDRESS SEARCH (GEOCODING) ---
        // Expose globally so it can be called by the event listener 
        async function searchAddress() { // Removed window. prefix
            const query = document.getElementById('address-search-input').value.trim();
            if (!query) return;
            
            updateStatus('Searching...', 'bg-indigo-500');

            // Exit manual mode if searching
            setManualDropMode(false);

            try {
                const searchUrl = NOMINATIM_URL + encodeURIComponent(query);
                console.log("Nominatim Query URL:", searchUrl); // Log the full URL
                const response = await fetch(searchUrl);
                if (!response.ok) throw new Error("Search API failed with status: " + response.status);

                const data = await response.json();

                if (data && data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    
                    map.setView([lat, lng], 15);
                    
                    // Automatically drop a temporary pin and open the modal
                    // Pass the display name of the result to pre-fill the input
                    onMapClick({ latlng: { lat: lat, lng: lng } }, result.display_name); 
                    updateStatus('Pin placed from search', 'bg-green-600');

                } else {
                    console.error("Geocoding Search: Address not found for query:", query);
                    // Updated message to suggest simplification
                    updateStatus('Address Not Found (Try simpler query or Manual Pin)', 'bg-yellow-500'); 
                }
            } catch (error) {
                console.error("Geocoding Error:", error);
                updateStatus('Search Error: See Console', 'bg-red-500');
            }
        }
        window.searchAddress = searchAddress; // Explicitly expose to window object

        
        // --- MANUAL PIN DROP MODE TOGGLE ---
        function toggleManualPinMode() { // Removed window. prefix
            setManualDropMode(!isManualDropMode);
        }
        
        function setManualDropMode(enabled) {
            isManualDropMode = enabled;
            const body = document.body;
            const button = document.getElementById('manual-pin-btn');

            if (enabled) {
                body.classList.add('manual-drop-mode');
                button.classList.remove('bg-red-500');
                button.classList.add('bg-gray-700');
                updateStatus('Click on the map to drop the pin...', 'bg-red-500');
            } else {
                body.classList.remove('manual-drop-mode');
                button.classList.remove('bg-gray-700');
                button.classList.add('bg-red-500');
                if (isAppInitialized) {
                     updateStatus('Map & Database Ready', 'bg-green-600');
                }
            }
        }

        // --- MAP CLICK HANDLER ---
        function onMapClick(e, address = '') {
            if (e.latlng) {
                // If in manual mode, drop the pin at the center of the crosshair
                if (isManualDropMode) {
                    // In manual mode, the coordinates are based on the click event (e.latlng)
                    setManualDropMode(false); // Exit mode after click
                    // Don't need to pass an address as the user is visually dropping it
                } 
                // If not in manual mode, this call came from the search function, or a normal background map click
                // and the behavior is the same: drop a temp pin and open the modal.

                removeTempMarker();
                
                currentMarkerData.lat = e.latlng.lat;
                currentMarkerData.lng = e.latlng.lng;
                currentMarkerData.id = null; // Ensure we are creating a new pin

                // Create a temporary, bouncing marker
                const tempIcon = L.divIcon({
                    className: 'custom-temp-icon',
                    html: `<div style="background-color: #EF4444; border-color: white; transform: rotate(45deg); border-width: 3px; position: relative; bottom: 10px;" class="w-5 h-5 rounded-full shadow-lg flex items-center justify-center text-white font-bold">
                            <svg class="h-4 w-4 transform -rotate-45" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.899A5.82 5.82 0 0110 18V8a2 2 0 014 0v10l3.657-3.657a1 1 0 011.414 1.414z"/>
                            </svg>
                           </div>`,
                    iconAnchor: [12, 24],
                });
                tempMarker = L.marker([e.latlng.lat, e.latlng.lng], { icon: tempIcon }).addTo(map);

                openModal({ name: address, lat: e.latlng.lat, lng: e.latlng.lng });
            }
        }

        function removeTempMarker() {
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }

        // --- MODAL HANDLING ---

        function openModal(pinData = null) { // Removed window. prefix
            const modal = document.getElementById('pin-modal');
            const nameInput = document.getElementById('property-name');
            const statusSelect = document.getElementById('property-status');
            const notesTextarea = document.getElementById('property-notes');
            const pinIdInput = document.getElementById('pin-id');
            const latDisplay = document.getElementById('modal-lat');
            const lngDisplay = document.getElementById('modal-lng');
            const title = document.getElementById('modal-title');
            const deleteBtn = document.getElementById('delete-pin-btn');

            // Reset inputs for new pin
            nameInput.value = pinData.name || '';
            statusSelect.value = pinData.status || 'Watching';
            notesTextarea.value = pinData.notes || '';
            pinIdInput.value = pinData.id || '';
            deleteBtn.classList.add('hidden');

            // Set coordinates display
            latDisplay.textContent = currentMarkerData.lat ? currentMarkerData.lat.toFixed(5) : 'N/A';
            lngDisplay.textContent = currentMarkerData.lng ? currentMarkerData.lng.toFixed(5) : 'N/A';


            if (pinData && pinData.id) {
                title.textContent = 'Edit Watch Location';
                
                currentMarkerData.id = pinData.id;
                currentMarkerData.lat = pinData.lat;
                currentMarkerData.lng = pinData.lng;
                removeTempMarker(); // If editing an existing pin, remove any temp marker

                deleteBtn.classList.remove('hidden');
            } else {
                 title.textContent = 'New Location Watch';
                 if (!currentMarkerData.lat || !currentMarkerData.lng) {
                     console.error("Attempted to open modal without valid coordinates.");
                     return;
                 }
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            }, 50); 
        }

        function closeModal() { // Removed window. prefix
            const modal = document.getElementById('pin-modal');
            modal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                
                // Clear state after closing and remove temp marker
                currentMarkerData.id = null;
                currentMarkerData.lat = null;
                currentMarkerData.lng = null;
                removeTempMarker();
                setManualDropMode(false); // Ensure mode is off when closing modal

            }, 300);
        }

        // --- FIREBASE CRUD OPERATIONS ---
        
        function getPinCollectionRef() {
            // Using the public path for shared data: /artifacts/{appId}/public/data/pins
            return collection(db, `artifacts/${appId}/public/data/pins`);
        }

        async function savePin() { // Removed window. prefix
            if (!currentUserId || !db || !currentMarkerData.lat || !currentMarkerData.lng) {
                console.error("Authentication, database, or coordinates not ready. Cannot save pin.");
                return;
            }

            const name = document.getElementById('property-name').value.trim() || 'Untitled Property';
            const status = document.getElementById('property-status').value;
            const notes = document.getElementById('property-notes').value.trim();
            const pinId = document.getElementById('pin-id').value;

            const pinData = {
                name: name,
                status: status,
                notes: notes,
                lat: currentMarkerData.lat,
                lng: currentMarkerData.lng,
                updatedAt: new Date(),
                userId: currentUserId 
            };
            
            try {
                if (pinId) {
                    const pinDocRef = doc(getPinCollectionRef(), pinId);
                    await updateDoc(pinDocRef, pinData);
                } else {
                    await addDoc(getPinCollectionRef(), pinData);
                }
                
                closeModal();
            } catch (error) {
                console.error("Error saving pin to Firestore (Check Security Rules!):", error);
            }
        }

        async function deletePin() { // Removed window. prefix
            const pinId = document.getElementById('pin-id').value;
            if (!pinId || !db) {
                console.error("Pin ID or database not ready for deletion.");
                return;
            }

            try {
                const pinDocRef = doc(getPinCollectionRef(), pinId);
                await deleteDoc(pinDocRef);
                closeModal();
            } catch (error) {
                console.error("Error deleting pin from Firestore:", error);
            }
        }

        // --- REAL-TIME DATA LISTENER ---

        function startDataListener() {
            if (!currentUserId || !db) return;

            const pinsQuery = query(getPinCollectionRef());

            onSnapshot(pinsQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const pinId = change.doc.id;
                    const pinData = { id: pinId, ...data };

                    if (change.type === "added") {
                        addMarker(pinData);
                    } else if (change.type === "modified") {
                        updateMarker(pinData);
                    } else if (change.type === "removed") {
                        removeMarker(pinId);
                    }
                });
            }, (error) => {
                console.error("Error listening to pin changes (Ensure public path rules are set):", error);
                updateStatus('Sync Error', 'bg-red-500');
            });
        }
        
        // --- MARKER RENDERING ---
        
        function getStatusColor(status) {
            switch(status) {
                case 'Watching': return { color: '#3B82F6', tailwind: 'bg-blue-600' };
                case 'Contacted': return { color: '#F97316', tailwind: 'bg-orange-600' };
                case 'Offer Made': return { color: '#DC2626', tailwind: 'bg-red-600' };
                case 'Rejected': return { color: '#6B7280', tailwind: 'bg-gray-600' };
                case 'Purchased': return { color: '#10B981', tailwind: 'bg-green-600' };
                default: return { color: '#3B82F6', tailwind: 'bg-blue-600' };
            }
        }

        function createPopupContent(pin) {
            const statusInfo = getStatusColor(pin.status);
            const notesHtml = pin.notes ? `<p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">${pin.notes}</p>` : '';
            const statusHtml = `<span style="background-color: ${statusInfo.color};" class="inline-block px-3 py-1 text-xs font-semibold text-white rounded-full">${pin.status}</span>`; 
            
            const content = `
                <div class="p-3">
                    <h3 class="text-lg font-bold mb-1">${pin.name}</h3>
                    ${statusHtml}
                    ${notesHtml}
                    <button class="mt-3 text-indigo-600 hover:text-indigo-800 font-medium text-sm" data-pin-id="${pin.id}" onclick="editPin(this)">Edit Details</button>
                </div>
            `;
            return content;
        }

        function createCustomIcon(color) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; border-color: white; transform: rotate(45deg); border-width: 3px; position: relative; bottom: 10px;" class="w-5 h-5 rounded-full shadow-lg flex items-center justify-center text-white font-bold">
                        <svg class="h-4 w-4 transform -rotate-45" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.899A5.82 5.82 0 0110 18V8a2 2 0 014 0v10l3.657-3.657a1 1 0 011.414 1.414z"/>
                        </svg>
                       </div>`,
                iconAnchor: [12, 24],
                popupAnchor: [0, -25]
            });
        }

        function addMarker(pin) {
            if (markers[pin.id]) return;

            const color = getStatusColor(pin.status).color;
            const customIcon = createCustomIcon(color);

            const marker = L.marker([pin.lat, pin.lng], { icon: customIcon }).addTo(map);
            marker.bindPopup(createPopupContent(pin));
            
            markers[pin.id] = { marker, pin };
        }

        function updateMarker(pin) {
            const markerEntry = markers[pin.id];
            if (!markerEntry) {
                addMarker(pin);
                return;
            }

            const color = getStatusColor(pin.status).color;
            markerEntry.marker.setIcon(createCustomIcon(color));
            
            markerEntry.marker.setPopupContent(createPopupContent(pin));
            markerEntry.pin = pin;
        }

        function removeMarker(pinId) {
            if (markers[pinId]) {
                map.removeLayer(markers[pinId].marker);
                delete markers[pinId];
            }
        }

        window.editPin = function(el) { // KEEP window. prefix as it's used in dynamically generated popup HTML
            const pinId = el.getAttribute('data-pin-id');
            const pinData = markers[pinId]?.pin;
            if (pinData) {
                map.closePopup(); 
                openModal(pinData);
            }
        }
        
        // --- EVENT LISTENERS ---
        function attachEventListeners() {
            // Primary UI Controls
            document.getElementById('search-btn').addEventListener('click', searchAddress); 
            document.getElementById('manual-pin-btn').addEventListener('click', toggleManualPinMode); // FIXED: Manual Pin Button

            // Modal Controls (FIXED: Save/Delete/Close Buttons)
            document.getElementById('close-modal-btn').addEventListener('click', closeModal); 
            document.getElementById('save-pin-btn').addEventListener('click', savePin);
            document.getElementById('delete-pin-btn').addEventListener('click', deletePin); 
            
            // Search Input 'Enter' Key
            document.getElementById('address-search-input').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    searchAddress();
                }
            });
        }

        // Start the application initialization chain
        window.onload = function () {
            initFirebase();
        }

    </script>
</body>
</html>
