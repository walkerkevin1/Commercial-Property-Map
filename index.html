<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Location Watchlist (Cloud Sync)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a clean, full-screen map experience */
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }
        #map {
            width: 100%;
            height: 100%;
            transition: all 0.3s ease-in-out;
            opacity: 0; /* Starts hidden until loaded */
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }
        /* Style the map info window */
        .gm-style .gm-style-iw-d {
            max-height: 200px;
            overflow-y: auto;
            max-width: 300px !important;
        }
        .infowindow-content {
            font-size: 14px;
            padding: 5px;
        }
        .infowindow-notes {
            white-space: pre-wrap;
            margin-top: 5px;
            font-style: italic;
        }
        #searchContainer {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            width: 90%;
            max-width: 400px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-400"></div>
        <p class="mt-4 text-xl font-medium">Initializing Map & Cloud Sync...</p>
        <p id="loadingStatus" class="mt-2 text-sm text-indigo-300">Connecting to database and authenticating...</p>
    </div>

    <!-- Search Bar -->
    <div id="searchContainer" class="hidden">
        <input type="text" id="searchPins" placeholder="Search pins by name, address, or notes..."
               class="w-full rounded-lg border border-gray-300 shadow-xl focus:border-indigo-500 focus:ring-indigo-500 p-3 transition duration-150">
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Pin/Note Modal -->
    <div id="pinModal" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-75 flex items-center justify-center p-4" onclick="closeModal(event)">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all sm:my-8 sm:align-middle sm:p-6" onclick="event.stopPropagation()">
            <div class="p-6">
                <h3 id="modalTitle" class="text-2xl leading-6 font-extrabold text-gray-900 mb-4">Add New Location Watch</h3>

                <label for="locationName" class="block text-sm font-medium text-gray-700">Location Label (Address/Name)</label>
                <input type="text" id="locationName" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 mb-4" placeholder="e.g., Target Development Site">

                <label for="locationStatus" class="block text-sm font-medium text-gray-700">Watch Status</label>
                <select id="locationStatus" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 mb-4">
                    <option value="Active Watch">Active Watch</option>
                    <option value="Planning/Due Diligence">Planning/Due Diligence</option>
                    <option value="Offer Made/Negotiating">Offer Made/Negotiating</option>
                    <option value="Deal Closed/Inactive">Deal Closed/Inactive</option>
                    <option value="Rejected/Dead Deal">Rejected/Dead Deal</option>
                </select>

                <label for="locationNotes" class="block text-sm font-medium text-gray-700">Notes (Zoning, Next Steps, Contacts)</label>
                <textarea id="locationNotes" rows="5" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3" placeholder="Enter detailed notes here..."></textarea>
            </div>

            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 space-y-2 sm:space-y-0 sm:space-x-2">
                <button type="button" id="savePinBtn" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:ml-3 sm:text-sm transition ease-in-out duration-150">
                    Save Location
                </button>
                <button type="button" onclick="closeModal()" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-gray-300 bg-white px-4 py-2 text-base font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 sm:mt-0 sm:text-sm transition ease-in-out duration-150">
                    Cancel
                </button>
                <button type="button" id="deletePinBtn" class="w-full sm:w-auto inline-flex justify-center rounded-lg border border-red-500 bg-white px-4 py-2 text-base font-medium text-red-500 shadow-sm hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 sm:mt-0 sm:text-sm transition ease-in-out duration-150 hidden">
                    Delete Location
                </button>
            </div>
             <p class="text-xs text-gray-400 text-center py-1">User ID: <span id="userIdDisplay">Loading...</span></p>
        </div>
    </div>

    <!-- Google Maps API Script Load -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvoU7dbseG64ssYhFdrtCigwIePv_om_w&loading=async"></script>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables will be populated here
        let db = null;
        let auth = null;
        let userId = 'anonymous'; // Default user ID
        let isLocalMode = false; // Flag to indicate running without real Firebase

        // --- MANDATORY CANVAS ENVIRONMENT VARIABLE HANDLING ---
        // These are provided by the canvas environment for cloud functionality.
        const MOCK_API_KEY = "AIzaSy_LOCAL_MOCK_KEY";
        const defaultFirebaseConfig = { apiKey: MOCK_API_KEY }; // Minimal mock config

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let firebaseConfig = defaultFirebaseConfig;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.warn("Could not parse __firebase_config. Using default mock config.");
            }
        }
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END MANDATORY VARIABLE HANDLING ---


        // Map and Pin management variables
        let map;
        let markers = {}; // Stores Google Maps Markers keyed by Firestore doc ID
        let currentMarkerData = null; // Stores data for the pin currently being edited/added
        let allPinsData = {}; // Cache of all pin data for quick filtering

        // DOM elements
        const pinModal = document.getElementById('pinModal');
        const locationNameInput = document.getElementById('locationName');
        const locationStatusSelect = document.getElementById('locationStatus');
        const locationNotesInput = document.getElementById('locationNotes');
        const savePinBtn = document.getElementById('savePinBtn');
        const deletePinBtn = document.getElementById('deletePinBtn');
        const modalTitle = document.getElementById('modalTitle');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loadingStatus = document.getElementById('loadingStatus');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const searchPinsInput = document.getElementById('searchPins');

        // --- Utility Functions ---

        /** Gets the color for the marker based on the status. */
        function getMarkerColor(status) {
            switch (status) {
                case 'Active Watch': return '#4F46E5'; // Indigo
                case 'Planning/Due Diligence': return '#F59E0B'; // Amber
                case 'Offer Made/Negotiating': return '#10B981'; // Emerald
                case 'Deal Closed/Inactive': return '#6B7280'; // Gray
                case 'Rejected/Dead Deal': return '#EF4444'; // Red
                default: return '#4F46E5';
            }
        }

        /** Converts location data into HTML for the InfoWindow. */
        function createInfoWindowContent(data) {
            return `
                <div class="infowindow-content font-semibold text-gray-800">
                    <h4 class="text-lg font-bold text-indigo-700 mb-1">${data.name || 'Untitled Location'}</h4>
                    <p class="text-sm text-gray-600 mb-2">
                        <span class="font-bold">Status:</span> ${data.status}
                    </p>
                    <p class="infowindow-notes text-gray-700 pt-2 border-t mt-2">
                        ${data.notes ? data.notes.replace(/\n/g, '<br>') : 'No notes added.'}
                    </p>
                    <button onclick="editPin('${data.id}')" class="mt-3 text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                        Edit Notes
                    </button>
                </div>
            `;
        }

        /** Opens the modal for adding or editing a pin. */
        function openModal(data = null) {
            currentMarkerData = data;
            locationNameInput.value = data ? data.name : '';
            locationNotesInput.value = data ? data.notes : '';
            locationStatusSelect.value = data && data.status ? data.status : 'Active Watch'; // Set status

            if (data && data.id) {
                modalTitle.textContent = 'Edit Location Watch';
                savePinBtn.textContent = 'Update Location';
                deletePinBtn.classList.remove('hidden');
            } else {
                modalTitle.textContent = 'Add New Location Watch';
                savePinBtn.textContent = 'Save Location';
                deletePinBtn.classList.add('hidden');
            }
            pinModal.classList.remove('hidden');
            // Focus on the name field for quick entry
            setTimeout(() => locationNameInput.focus(), 50);
        }

        /** Closes the modal. */
        window.closeModal = function(event) {
            if (event && event.target !== pinModal) return;
            pinModal.classList.add('hidden');
            currentMarkerData = null;
        }

        // --- Firestore Functions ---

        /** Gets the path to the user's private collection. */
        function getCollectionRef() {
            if (isLocalMode || !db || !userId) return null;
            // Private Data Path: /artifacts/{appId}/users/{userId}/{collectionName}
            const path = `artifacts/${appId}/users/${userId}/watched_locations`;
            return collection(db, path);
        }

        /** Saves a new pin or updates an existing one. */
        async function savePin() {
            const name = locationNameInput.value.trim() || 'Untitled Location';
            const notes = locationNotesInput.value.trim();
            const status = locationStatusSelect.value;
            const lat = currentMarkerData.lat;
            const lng = currentMarkerData.lng;
            const id = currentMarkerData.id;

            const pinData = { name, notes, status, lat, lng };

            if (isLocalMode) {
                // If running in local bypass mode, just close the modal.
                console.warn("Local Mode Active. Pins are NOT saved to the cloud.");
                closeModal();
                return;
            }

            // Real Firestore interaction
            if (!getCollectionRef()) {
                console.error('Firestore not initialized or userId missing.');
                return;
            }

            try {
                if (id) {
                    // Update existing document
                    const docRef = doc(getCollectionRef(), id);
                    const { lat, lng, ...updateFields } = pinData; // Exclude lat/lng from update payload
                    updateFields.timestamp = serverTimestamp(); // Use server timestamp for update
                    await updateDoc(docRef, updateFields);
                    console.log("Document updated with ID: ", id);
                } else {
                    // Add new document
                    pinData.timestamp = serverTimestamp(); // Use server timestamp for new doc
                    await addDoc(getCollectionRef(), pinData);
                    console.log("Document successfully written!");
                }
                closeModal();
            } catch (e) {
                console.error("Error saving document: ", e);
            }
        }

        /** Deletes the currently selected pin. */
        async function deletePin() {
            if (isLocalMode) {
                // If running in local bypass mode, just close the modal.
                console.warn("Local Mode Active. Pin deletion skipped.");
                closeModal();
                return;
            }
            if (!getCollectionRef() || !currentMarkerData || !currentMarkerData.id) return;
            try {
                const docRef = doc(getCollectionRef(), currentMarkerData.id);
                await deleteDoc(docRef);
                console.log("Document successfully deleted!");
                closeModal();
            } catch (e) {
                console.error("Error deleting document: ", e);
            }
        }

        /** Listens to Firestore for real-time updates and updates map markers. */
        function listenForPins() {
            if (!db || !userId) {
                console.warn("Cannot start Firestore listener: Database or User ID is not ready.");
                return;
            }
            const q = query(getCollectionRef());
            onSnapshot(q, (querySnapshot) => {
                const latestPins = {};

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const pinId = doc.id;
                    const pin = {
                        id: pinId,
                        lat: data.lat,
                        lng: data.lng,
                        name: data.name,
                        notes: data.notes,
                        status: data.status,
                        timestamp: data.timestamp,
                    };

                    latestPins[pinId] = pin;
                    allPinsData[pinId] = pin; // Update cache

                    if (markers[pinId]) {
                        // Pin exists, update its marker and data
                        markers[pinId].set('data', pin);
                        markers[pinId].setIcon({
                             path: google.maps.SymbolPath.CIRCLE,
                             scale: 8,
                             fillColor: getMarkerColor(pin.status),
                             fillOpacity: 0.9,
                             strokeWeight: 2,
                             strokeColor: '#FFFFFF',
                        });
                        if (markers[pinId].get('infoWindow').getMap() === map) {
                            markers[pinId].get('infoWindow').setContent(createInfoWindowContent(pin));
                        }
                    } else {
                        // New Pin, create a marker
                        createMapMarker(pin);
                    }
                });

                // Check for deleted pins and remove their markers
                Object.keys(markers).forEach(pinId => {
                    if (!latestPins[pinId]) {
                        markers[pinId].setMap(null);
                        delete markers[pinId];
                        delete allPinsData[pinId];
                    }
                });

                filterPins(); // Re-apply filter after the data update
                console.log(`Map updated. Total pins: ${Object.keys(markers).length}`);
            }, (error) => {
                console.error("Firestore onSnapshot error:", error);
                loadingStatus.textContent = "ðŸ›‘ DB Connection Error. Check console logs.";
            });
        }


        // --- Map Functions ---

        /** Creates and adds a Google Maps Marker to the map/markers list. */
        function createMapMarker(pin) {
            const marker = new google.maps.Marker({
                position: { lat: pin.lat, lng: pin.lng },
                map,
                title: pin.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 8,
                    fillColor: getMarkerColor(pin.status),
                    fillOpacity: 0.9,
                    strokeWeight: 2,
                    strokeColor: '#FFFFFF',
                },
            });

            marker.set('data', pin);
            const infoWindow = new google.maps.InfoWindow({
                content: createInfoWindowContent(pin),
            });
            marker.set('infoWindow', infoWindow);

            marker.addListener("click", () => {
                Object.values(markers).forEach(m => m.get('infoWindow').close());
                infoWindow.setContent(createInfoWindowContent(marker.get('data'))); 
                infoWindow.open({ map, anchor: marker });
            });

            markers[pin.id] = marker;
            return marker;
        }


        /** Edits a pin from the InfoWindow button. */
        window.editPin = function(docId) {
            const marker = markers[docId];
            if (marker) {
                const data = marker.get('data');
                openModal(data);
            } else {
                console.error("Marker not found for editing:", docId);
            }
        };

        /** Attempts to get user's geolocation, falling back to a default location. */
        function getInitialLocation(callback) {
            loadingStatus.textContent = "Requesting your location...";
            const defaultLocation = { lat: 34.0522, lng: -118.2437 }; // Los Angeles

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        loadingStatus.textContent = "Location found. Building map...";
                        callback({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        });
                    },
                    (error) => {
                        console.warn("Geolocation failed or denied. Falling back to default location.", error);
                        loadingStatus.textContent = "Using default location (Los Angeles)...";
                        callback(defaultLocation);
                    },
                    { timeout: 5000, enableHighAccuracy: true }
                );
            } else {
                console.warn("Geolocation not supported by this browser. Falling back to default location.");
                loadingStatus.textContent = "Using default location (Los Angeles)...";
                callback(defaultLocation);
            }
        }

        /** Initializes the Google Map. */
        function initMap(center) {
            map = new google.maps.Map(document.getElementById("map"), {
                center: center,
                zoom: 12,
                mapId: 'DEMO_MAP_ID',
                disableDefaultUI: true,
                zoomControl: true,
                streetViewControl: false,
                mapTypeControl: false,
            });

            // Hide loading screen, make map visible and search bar active
            loadingOverlay.classList.add('hidden');
            document.getElementById('map').style.opacity = 1;
            document.getElementById('searchContainer').classList.remove('hidden');

            // Add listener for placing a new pin
            map.addListener("click", (mapsMouseEvent) => {
                const lat = mapsMouseEvent.latLng.lat();
                const lng = mapsMouseEvent.latLng.lng();
                openModal({ lat, lng, name: '', status: 'Active Watch', notes: '' });
            });
            
            // Only start real-time listener if not in local mode
            if (!isLocalMode) {
                 listenForPins();
            } else {
                console.warn("Local Mode Active. Firestore listener skipped.");
            }
        }

        /** Filters markers based on the search input value. */
        function filterPins() {
            const query = searchPinsInput.value.toLowerCase();
            const keys = Object.keys(markers);
            let firstVisibleMarker = null;

            keys.forEach(pinId => {
                const marker = markers[pinId];
                const data = allPinsData[pinId]; // Use cached data

                if (!data) return;

                const name = data.name.toLowerCase();
                const notes = data.notes.toLowerCase();
                const status = data.status.toLowerCase();

                const isMatch = name.includes(query) || notes.includes(query) || status.includes(query);

                marker.setVisible(isMatch);
                if (isMatch && !firstVisibleMarker) {
                    firstVisibleMarker = marker;
                }
            });
        }

        // --- Initial Setup and Event Listeners ---

        /** Function to wait for the Google Maps object to be loaded */
        function waitForMapsLoad() {
            if (typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                loadingStatus.textContent = "Google Maps loaded. Getting location...";
                getInitialLocation(initMap);
            } else {
                loadingStatus.textContent = "Waiting for Google Maps SDK to load...";
                setTimeout(waitForMapsLoad, 200); // Check again after 200ms
            }
        }
        
        window.onload = function() {
            setLogLevel('Debug');
            
            // --- LOCAL MODE CHECK AND BYPASS ---
            if (firebaseConfig.apiKey === MOCK_API_KEY) {
                isLocalMode = true;
                userId = 'local-mode-user';
                userIdDisplay.textContent = `${userId} (LOCAL MODE - NO CLOUD SAVE)`;
                loadingStatus.textContent = "Running in Local Mode. Bypassing Firebase Auth...";
                waitForMapsLoad(); // Skip all Firebase logic and go straight to map load
                return;
            }
            // --- END LOCAL MODE CHECK ---


            // Initialize Firebase App
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (e) {
                console.error("CRITICAL FIREBASE INITIALIZATION ERROR:", e);
                loadingStatus.textContent = "ðŸ›‘ Database Init Failed. Check Console for details.";
                return;
            }

            // Handle Authentication and get User ID
            onAuthStateChanged(auth, async (user) => {
                loadingStatus.textContent = "Authentication listener triggered...";

                if (user) {
                    // Scenario 1: User already signed in or successfully signed in via token/anon
                    userId = user.uid;
                    loadingStatus.textContent = "Authenticated successfully. User ID ready.";
                } else if (initialAuthToken) {
                    // Scenario 2: Attempt to sign in using the provided custom token
                    loadingStatus.textContent = "Attempting sign-in with custom token...";
                    try {
                        const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        userId = userCredential.user.uid;
                        loadingStatus.textContent = "Signed in with custom token. User ID ready.";
                    } catch (error) {
                        console.warn("Custom token sign-in failed. Falling back to anonymous.", error);
                        // Fallback to anonymous sign-in
                        try {
                            const userCredential = await signInAnonymously(auth);
                            userId = userCredential.user.uid;
                            loadingStatus.textContent = "Signed in anonymously (Fallback). User ID ready.";
                        } catch (e) {
                            console.error("ANONYMOUS SIGN-IN FAILED.", e);
                            loadingStatus.textContent = "CRITICAL ERROR: Failed to sign in anonymously. Check console.";
                            return;
                        }
                    }
                } else {
                    // Scenario 3: No token available, use anonymous sign-in
                    loadingStatus.textContent = "No token found. Signing in anonymously...";
                    try {
                        const userCredential = await signInAnonymously(auth);
                        userId = userCredential.user.uid;
                        loadingStatus.textContent = "Signed in anonymously. User ID ready.";
                    } catch (e) {
                        console.error("ANONYMOUS SIGN-IN FAILED. Execution halted.", e);
                        loadingStatus.textContent = "CRITICAL ERROR: Failed to sign in anonymously. Check console.";
                        return;
                    }
                }

                // Checkpoint: If authentication completed, proceed to map loading
                if (userId && userId !== 'anonymous') {
                    userIdDisplay.textContent = userId;
                    waitForMapsLoad();
                } else {
                    console.error("Authentication check failed to yield a valid user ID.");
                    loadingStatus.textContent = "CRITICAL ERROR: Invalid User ID after sign-in attempts.";
                }
            });

            // Set up button handlers for the modal
            savePinBtn.addEventListener('click', savePin);
            deletePinBtn.addEventListener('click', deletePin);

            // Set up search filter listener
            searchPinsInput.addEventListener('keyup', filterPins);
            searchPinsInput.addEventListener('change', filterPins);
        };
    </script>
    <!-- force commit -->
</body>
</html>
<!-- force commit -->
