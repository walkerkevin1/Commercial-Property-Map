<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Commercial Property Map Watcher</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d8/QFX/jT6858e+MGEa2/s4X5/z1z/4s8c8M8M2Q2Q==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d8/QFX/jT6858e+MGEa2/s4X5/z1z/4s8c8M8M2Q2Q==" crossorigin=""></script>
    <style>
        /* Custom styles for map container */
        #map {
            height: 100vh;
            width: 100vw;
            /* Ensure the map is full screen and centered */
        }
        /* Style for the custom modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
        /* Custom card style */
        .card-shadow {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* Custom popup content styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0;
        }
        .leaflet-popup-content {
            margin: 0;
            padding: 1rem;
            max-width: 300px !important;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
        <p class="mt-4 text-lg font-semibold text-indigo-700">Initializing Map & Cloud Sync...</p>
        <p class="text-sm text-gray-500">Connecting to database and authenticating...</p>
    </div>

    <!-- Main Map Container -->
    <div id="map"></div>

    <!-- Floating Add Button -->
    <button id="add-pin-btn" class="fixed bottom-6 right-6 p-4 bg-indigo-600 text-white rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105 z-40 focus:outline-none focus:ring-4 focus:ring-indigo-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
        </svg>
    </button>

    <!-- Pin Detail Modal -->
    <div id="pin-modal" class="modal-backdrop fixed inset-0 hidden items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl overflow-hidden card-shadow w-11/12 max-w-lg mx-auto transform transition-transform duration-300 scale-95 opacity-0">
            
            <header class="p-4 bg-indigo-600 text-white flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-bold">New Location Watch</h2>
                <button onclick="closeModal()" class="text-white hover:text-indigo-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </header>

            <div class="p-6 space-y-4">
                <input type="hidden" id="pin-id">
                
                <div>
                    <label for="property-name" class="block text-sm font-medium text-gray-700 mb-1">Property Name / Address</label>
                    <input type="text" id="property-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="E.g., 123 Main St - Corner Lot">
                </div>

                <div>
                    <label for="property-status" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="property-status" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Watching">Watching (Initial Interest)</option>
                        <option value="Contacted">Contacted Owner/Agent</option>
                        <option value="Offer Made">Offer Made</option>
                        <option value="Rejected">Rejected/No longer viable</option>
                        <option value="Purchased" class="font-bold text-green-600">Purchased/Complete</option>
                    </select>
                </div>

                <div>
                    <label for="property-notes" class="block text-sm font-medium text-gray-700 mb-1">Notes / Key Takeaways</label>
                    <textarea id="property-notes" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Max bid, key features, zoning restrictions, etc."></textarea>
                </div>
            </div>

            <footer class="p-4 bg-gray-50 flex justify-between items-center border-t border-gray-200">
                <button id="delete-pin-btn" onclick="deletePin()" class="text-red-600 hover:text-red-700 font-medium hidden">Delete</button>
                <button id="save-pin-btn" onclick="savePin()" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 font-semibold">
                    Save Location
                </button>
            </footer>
        </div>
    </div>
    
    <!-- User Info Footer -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/70 backdrop-blur-sm p-1 text-xs text-gray-500 flex justify-center z-30">
        User ID: <span id="user-id-display" class="font-mono ml-2">Loading...</span> | Cloud App: <span id="app-id-display" class="font-mono ml-2">Loading...</span>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Enable Firebase Firestore debugging (optional, but good for troubleshooting)
        setLogLevel('Debug');

        // --- START: MANUAL FIREBASE CONFIGURATION (FINAL CORRECTED BLOCK) ---
        // This configuration enables cloud syncing using your personal Firebase project.
        // It replaces all Canvas environment variables.

        const appId = 'default-app-id'; // Constant needed for the Firestore path

        const firebaseConfig = {
            apiKey: "AIzaSyABT1nSD5liNMuVvAtmIw7sQAf_SJRuvCs",
            authDomain: "commercial-property-map.firebaseapp.com",
            projectId: "commercial-property-map",
            storageBucket: "commercial-property-map.firebasestorage.app",
            messagingSenderId: "486434169699",
            appId: "1:486434169699:web:f0bb313ced152ca36b6956",
            measurementId: "G-RGQL6TKEGK"
        };

        // Setting the initial auth token to null forces the Anonymous Sign-In to run.
        const initialAuthToken = null; 
        // --- END: MANUAL FIREBASE CONFIGURATION (FINAL CORRECTED BLOCK) ---

        // Initialize App and Services
        let app;
        let db;
        let auth;
        let map;
        let currentUserId = null;
        let markers = {}; 

        // Initial map location (centered on a major US area as a fallback)
        const DEFAULT_LAT = 34.0522; 
        const DEFAULT_LNG = -118.2437; // Los Angeles

        let currentMarkerData = {
            id: null,
            lat: null,
            lng: null,
            marker: null,
        };
        
        let isMapInitialized = false;

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Check if we have a custom token (from Canvas)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in for external hosting (GitHub Pages)
                    await signInAnonymously(auth);
                }
                
                // Auth state listener setup
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        document.getElementById('user-id-display').textContent = currentUserId;
                        document.getElementById('app-id-display').textContent = appId;
                        
                        // Proceed to map and data initialization only after successful authentication
                        if (!isMapInitialized) {
                            initMap();
                            startDataListener();
                        }
                    } else {
                        console.error("User is not signed in.");
                        document.getElementById('user-id-display').textContent = 'AUTH FAILED';
                        // Re-attempt sign-in if needed, though onAuthStateChanged should handle it
                    }
                });

            } catch (error) {
                console.error("Error during Firebase initialization or sign-in:", error);
                document.getElementById('loading-overlay').innerHTML = `
                    <p class="text-xl text-red-600">Initialization Failed</p>
                    <p class="mt-2 text-sm text-gray-600">Check console for error details.</p>
                `;
            }
        }
        
        // --- MAP INITIALIZATION ---

        function initMap() {
            if (isMapInitialized) return;

            // 1. Try to get current geolocation
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    setupLeafletMap(lat, lng);
                },
                (error) => {
                    console.warn(`Geolocation failed or denied. Falling back to default location. ${error.name}`);
                    // Fallback to default LA location
                    setupLeafletMap(DEFAULT_LAT, DEFAULT_LNG);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
            );
            
            isMapInitialized = true;
        }
        
        function setupLeafletMap(lat, lng) {
            // 2. Initialize Leaflet map
            map = L.map('map', { 
                zoomControl: false // Disable default zoom control
            }).setView([lat, lng], 13);
            
            // Add custom zoom control for better mobile UX
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Add tile layer (using standard OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // 3. Setup event listener for dropping new pins
            map.on('click', onMapClick);
            
            // Remove loading overlay now that map is drawn
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.add('hidden'); }, 500);
        }
        
        function onMapClick(e) {
            // Set temporary pin location data
            currentMarkerData.lat = e.latlng.lat;
            currentMarkerData.lng = e.latlng.lng;
            currentMarkerData.id = null; // New pin
            
            // Open modal to capture pin details
            openModal();
        }

        // --- MODAL HANDLING ---

        function openModal(pinData = null) {
            const modal = document.getElementById('pin-modal');
            const nameInput = document.getElementById('property-name');
            const statusSelect = document.getElementById('property-status');
            const notesTextarea = document.getElementById('property-notes');
            const pinIdInput = document.getElementById('pin-id');
            const title = document.getElementById('modal-title');
            const deleteBtn = document.getElementById('delete-pin-btn');

            // Reset form fields
            nameInput.value = '';
            statusSelect.value = 'Watching';
            notesTextarea.value = '';
            pinIdInput.value = '';
            deleteBtn.classList.add('hidden');
            title.textContent = 'New Location Watch';

            if (pinData) {
                // Populate fields for editing existing pin
                title.textContent = 'Edit Watch Location';
                pinIdInput.value = pinData.id;
                nameInput.value = pinData.name || '';
                statusSelect.value = pinData.status || 'Watching';
                notesTextarea.value = pinData.notes || '';
                
                currentMarkerData.id = pinData.id;
                currentMarkerData.lat = pinData.lat;
                currentMarkerData.lng = pinData.lng;

                deleteBtn.classList.remove('hidden');
            }

            // Display and animate modal
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            }, 50); 
        }

        window.closeModal = function() {
            const modal = document.getElementById('pin-modal');
            modal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                // Reset temporary data after closing
                currentMarkerData.id = null;
                currentMarkerData.lat = null;
                currentMarkerData.lng = null;
            }, 300);
        }

        // --- FIREBASE CRUD OPERATIONS ---
        
        function getPinCollectionRef() {
            // Firestore path: /artifacts/{appId}/users/{userId}/pins
            return collection(db, `artifacts/${appId}/users/${currentUserId}/pins`);
        }

        window.savePin = async function() {
            if (!currentUserId || !db) {
                console.error("Authentication or database not ready. Cannot save pin.");
                return;
            }

            const name = document.getElementById('property-name').value.trim() || 'Untitled Property';
            const status = document.getElementById('property-status').value;
            const notes = document.getElementById('property-notes').value.trim();
            const pinId = document.getElementById('pin-id').value;

            const pinData = {
                name: name,
                status: status,
                notes: notes,
                lat: currentMarkerData.lat,
                lng: currentMarkerData.lng,
                updatedAt: new Date(),
                userId: currentUserId 
            };
            
            try {
                if (pinId) {
                    // Update existing pin
                    const pinDocRef = doc(getPinCollectionRef(), pinId);
                    await updateDoc(pinDocRef, pinData);
                } else {
                    // Add new pin
                    await addDoc(getPinCollectionRef(), pinData);
                }
                
                closeModal();
            } catch (error) {
                console.error("Error saving pin to Firestore:", error);
                // Simple visual feedback for the user instead of alert()
                document.getElementById('save-pin-btn').textContent = 'Save Failed!';
                setTimeout(() => {
                    document.getElementById('save-pin-btn').textContent = 'Save Location';
                }, 2000);
            }
        }

        window.deletePin = async function() {
            const pinId = document.getElementById('pin-id').value;

            if (!pinId || !db) {
                console.error("Pin ID or database not ready for deletion.");
                return;
            }

            try {
                const pinDocRef = doc(getPinCollectionRef(), pinId);
                await deleteDoc(pinDocRef);
                closeModal();
            } catch (error) {
                console.error("Error deleting pin from Firestore:", error);
            }
        }

        // --- REAL-TIME DATA LISTENER ---

        function startDataListener() {
            if (!currentUserId || !db) {
                console.error("Cannot start listener: User ID or DB not available.");
                return;
            }

            const pinsQuery = query(getPinCollectionRef());

            onSnapshot(pinsQuery, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const pinId = change.doc.id;
                    const pinData = { id: pinId, ...data };

                    if (change.type === "added") {
                        addMarker(pinData);
                    } else if (change.type === "modified") {
                        updateMarker(pinData);
                    } else if (change.type === "removed") {
                        removeMarker(pinId);
                    }
                });
            }, (error) => {
                console.error("Error listening to pin changes:", error);
            });
        }
        
        // --- MARKER RENDERING ---
        
        function getStatusColor(status) {
            switch(status) {
                case 'Watching': return 'blue';
                case 'Contacted': return 'orange';
                case 'Offer Made': return 'red';
                case 'Rejected': return 'gray';
                case 'Purchased': return 'green';
                default: return 'blue';
            }
        }

        function createPopupContent(pin) {
            const color = getStatusColor(pin.status);
            const notesHtml = pin.notes ? `<p class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">${pin.notes}</p>` : '';
            const statusHtml = `<span class="inline-block px-3 py-1 text-xs font-semibold text-white bg-${color}-500 rounded-full">${pin.status}</span>`;
            
            const content = `
                <div class="p-3">
                    <h3 class="text-lg font-bold mb-1">${pin.name}</h3>
                    ${statusHtml}
                    ${notesHtml}
                    <button class="mt-3 text-indigo-600 hover:text-indigo-800 font-medium text-sm" data-pin-id="${pin.id}" onclick="editPin(this)">Edit Details</button>
                </div>
            `;
            return content;
        }

        function addMarker(pin) {
            if (markers[pin.id]) return; // Already exists

            const color = getStatusColor(pin.status);
            
            const customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="bg-${color}-500 w-6 h-6 rounded-full border-4 border-white shadow-md transform rotate-45 relative bottom-3"></div>`,
                iconAnchor: [12, 24],
                popupAnchor: [0, -15]
            });

            const marker = L.marker([pin.lat, pin.lng], { icon: customIcon }).addTo(map);
            marker.bindPopup(createPopupContent(pin));
            
            // Store marker and data
            markers[pin.id] = { marker, pin };
        }

        function updateMarker(pin) {
            const markerEntry = markers[pin.id];
            if (!markerEntry) {
                addMarker(pin);
                return;
            }

            // Update marker icon color if needed
            const color = getStatusColor(pin.status);
            const customIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="bg-${color}-500 w-6 h-6 rounded-full border-4 border-white shadow-md transform rotate-45 relative bottom-3"></div>`,
                iconAnchor: [12, 24],
                popupAnchor: [0, -15]
            });
            markerEntry.marker.setIcon(customIcon);
            
            // Update the popup content
            markerEntry.marker.setPopupContent(createPopupContent(pin));

            // Update stored data
            markerEntry.pin = pin;
        }

        function removeMarker(pinId) {
            if (markers[pinId]) {
                map.removeLayer(markers[pinId].marker);
                delete markers[pinId];
            }
        }

        window.editPin = function(el) {
            const pinId = el.getAttribute('data-pin-id');
            const pinData = markers[pinId]?.pin;
            if (pinData) {
                // Close popup before opening modal
                map.closePopup(); 
                openModal(pinData);
            }
        }
        
        // --- BUTTON HANDLERS ---
        document.getElementById('add-pin-btn').addEventListener('click', () => {
            // Set temporary location to map center when using the button
            const center = map.getCenter();
            currentMarkerData.lat = center.lat;
            currentMarkerData.lng = center.lng;
            openModal();
        });


        // --- ENTRY POINT ---
        window.onload = function () {
            initFirebase();
        }

    </script>
</body>
</html>
